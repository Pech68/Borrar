<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Separador Inteligente de Contabilidad (AI Logic)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Librer칤as PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .animate-spin-slow { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .toggle-checkbox:checked {
            right: 0;
            border-color: #2563EB;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #2563EB;
        }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONOS SVG ---
        const Icons = {
            Brain: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/><path d="M3.477 10.896a4 4 0 0 1 .585-.396"/><path d="M19.938 10.5a4 4 0 0 1 .585.396"/><path d="M6 18a4 4 0 0 1-1.97-3.465"/><path d="M20 14.535A4 4 0 0 1 18 18"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            FileCheck: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></svg>,
            Layers: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Alert: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M19 19v4"/><path d="M23 21h-4"/></svg>
        };

        // --- L칍GICA DE DETECCI칍N CL츼SICA (REGEX) ---
        const ClassicLogic = {
            // Se han ampliado las palabras clave para asegurar el corte
            HEADERS: [
                "COMPROBANTE CONTABLE", 
                "NOTA DE CONTABILIDAD", 
                "COMPROBANTE DE EGRESO", 
                "RECIBO DE CAJA", 
                "COMPROBANTE DE DIARIO", 
                "NOTA BANCARIA",
                "COMPROBANTE", // M치s gen칠rico para asegurar corte
                "EGRESO NO",
                "RECIBO NO"
            ],
            normalize: (text) => text.replace(/\s+/g, ' ').toUpperCase(),
            extractNumber: (text) => {
                const strictPattern = /(?:NO\.|NO|NRO)\s*(\d{1,10})/i;
                const matchStrict = text.match(strictPattern);
                if (matchStrict && matchStrict[1]) return matchStrict[1];
                
                // Intento secundario: buscar n칰meros aislados grandes cerca de palabras clave
                const loosePattern = /(?:COMPROBANTE|NOTA).*?(\d{3,10})/i;
                const matchLoose = text.match(loosePattern);
                if (matchLoose && matchLoose[1]) return matchLoose[1];

                return null;
            },
            detectType: (text) => {
                if (text.includes("EGRESO")) return "Egreso";
                if (text.includes("RECIBO")) return "Recibo";
                if (text.includes("DIARIO") || text.includes("CONTABLE") || text.includes("NOTA")) return "Nota";
                if (text.includes("FACTURA")) return "Factura";
                return "Doc";
            }
        };

        function App() {
            const [file, setFile] = useState(null);
            const [status, setStatus] = useState('idle'); // idle, analyzing, processing, ready, error
            const [progress, setProgress] = useState(0);
            const [log, setLog] = useState("");
            const [groupedDocs, setGroupedDocs] = useState([]);
            const [zipBlob, setZipBlob] = useState(null);
            
            // Configuraci칩n IA - API Key actualizada por defecto
            const [useAI, setUseAI] = useState(true);
            const [apiKey, setApiKey] = useState("AIzaSyCMemc73m5TijEz0lRRqTnnSBCPFtMqy1g"); 
            const [currentThinking, setCurrentThinking] = useState("");

            const handleFile = (e) => {
                const selected = e.target.files[0];
                if (selected && selected.type === "application/pdf") {
                    setFile(selected);
                    resetState();
                } else {
                    alert("Por favor selecciona un archivo PDF.");
                }
            };

            const resetState = () => {
                setStatus('idle');
                setProgress(0);
                setGroupedDocs([]);
                setZipBlob(null);
                setLog("");
                setCurrentThinking("");
            };

            // --- LLAMADA A GEMINI API ---
            const analyzePageWithAI = async (pageText) => {
                const prompt = `
                    Act칰a como un experto contable auditando un archivo PDF.
                    Analiza el siguiente texto extra칤do de una sola p치gina.
                    Tu misi칩n es decidir si esta p치gina es el INICIO de un NUEVO documento contable (Ej: Nota de Contabilidad, Comprobante de Egreso) o si es un SOPORTE/ANEXO de un documento anterior (Ej: Factura escaneada, email, planilla excel sin cabecera oficial).

                    Texto de la p치gina:
                    """${pageText.substring(0, 3000)}"""

                    Responde SOLO con un JSON v치lido con esta estructura:
                    {
                        "isStart": boolean, // true si es claramente el inicio de un documento contable oficial de la empresa (tiene cabecera, logo, t칤tulo 'COMPROBANTE', 'NOTA', etc.). false si parece un anexo o continuaci칩n.
                        "number": string | null, // El n칰mero consecutivo del documento si lo encuentras (Ej: "850", "NC-2024"). null si no hay.
                        "type": string, // "Nota", "Egreso", "Recibo", "Soporte", "Otro"
                        "reason": "Breve explicaci칩n de por qu칠 clasificaste as칤"
                    }
                `;

                try {
                    // Usando Gemini 2.0 Flash como solicitado
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 429) throw new Error("Rate limit");
                        if (response.status === 403) throw new Error("API Key inv치lida o faltante");
                        throw new Error("API Error: " + response.status);
                    }

                    const data = await response.json();
                    const textResponse = data.candidates[0].content.parts[0].text;
                    return JSON.parse(textResponse);
                } catch (error) {
                    console.warn("AI Error, intentando fallback...", error);
                    return null; 
                }
            };

            const analyzeAndProcess = async () => {
                if (!file) return;
                
                try {
                    setStatus('analyzing');
                    setLog("Cargando motor de an치lisis PDF...");
                    
                    // --- CORRECCI칍N CR칈TICA DE ARRAYBUFFER ---
                    // Obtenemos el buffer original del archivo
                    const originalBuffer = await file.arrayBuffer();
                    
                    // Creamos una COPIA para PDF.js, ya que al usar workers puede "desvincular" (detach) el buffer
                    const pdfJsBuffer = originalBuffer.slice(0);
                    
                    const pdfDoc = await pdfjsLib.getDocument({ data: pdfJsBuffer }).promise;
                    const numPages = pdfDoc.numPages;

                    let groups = [];
                    let currentGroup = null;

                    // --- FASE 1: AN츼LISIS ---
                    for (let i = 1; i <= numPages; i++) {
                        // Feedback visual
                        setProgress(Math.round((i / numPages) * 50));
                        setLog(`Analizando p치gina ${i} de ${numPages}...`);

                        const page = await pdfDoc.getPage(i);
                        const textContent = await page.getTextContent();
                        const rawText = textContent.items.map(s => s.str).join(' ');
                        const normalizedText = ClassicLogic.normalize(rawText);

                        let isStartOfDoc = false;
                        let docNumber = null;
                        let docType = "Doc";
                        let aiReason = "";

                        if (useAI) {
                            // --- L칍GICA IA GEMINI ---
                            setCurrentThinking("Consultando a Gemini 2.0 Flash...");
                            
                            // Peque침a pausa para evitar rate-limit
                            await new Promise(r => setTimeout(r, 200)); 

                            const aiResult = await analyzePageWithAI(normalizedText);
                            
                            if (aiResult) {
                                isStartOfDoc = aiResult.isStart;
                                docNumber = aiResult.number;
                                docType = aiResult.type || "Doc";
                                aiReason = aiResult.reason;
                                setCurrentThinking(`IA: ${aiResult.reason}`);
                            } else {
                                // Fallback a l칩gica cl치sica si falla la IA
                                setCurrentThinking("IA no respondi칩, usando reglas cl치sicas.");
                                isStartOfDoc = ClassicLogic.HEADERS.some(h => normalizedText.includes(h));
                                docNumber = ClassicLogic.extractNumber(normalizedText);
                            }

                        } else {
                            // --- L칍GICA CL츼SICA MEJORADA ---
                            // Ahora busca coincidencias m치s agresivas para evitar que todo sea un solo archivo
                            isStartOfDoc = ClassicLogic.HEADERS.some(h => normalizedText.includes(h));
                            docNumber = ClassicLogic.extractNumber(normalizedText);
                            docType = ClassicLogic.detectType(normalizedText);
                            setCurrentThinking("Usando detecci칩n por palabras clave.");
                        }

                        // --- GESTI칍N DE GRUPOS ---
                        // Forzar inicio si la IA dice que es soporte pero no hay grupo previo
                        if (!isStartOfDoc && !currentGroup) {
                            isStartOfDoc = true; 
                            docType = "Indeterminado";
                            aiReason = "Primera p치gina sin cabecera clara, forzando inicio.";
                        }

                        if (isStartOfDoc) {
                            // Cerrar grupo anterior
                            if (currentGroup) groups.push(currentGroup);

                            // Nombre del archivo
                            let finalNumber = docNumber;
                            if (!finalNumber) {
                                finalNumber = `Doc_${groups.length + 1}`;
                            }

                            // Nuevo grupo
                            currentGroup = {
                                id: groups.length + 1,
                                type: docType,
                                number: finalNumber,
                                startPage: i,
                                pages: [i - 1], 
                                confidence: useAI && aiReason ? 'IA Certificada' : (docNumber ? 'Alta' : 'Baja'),
                                reasoning: aiReason
                            };
                        } else {
                            // ES UN SOPORTE
                            if (currentGroup) {
                                currentGroup.pages.push(i - 1);
                            }
                        }
                    }

                    if (currentGroup) groups.push(currentGroup);
                    const validGroups = groups.filter(g => g.pages.length > 0);
                    setGroupedDocs(validGroups);
                    
                    // --- FASE 2: GENERACI칍N ---
                    setStatus('processing');
                    setCurrentThinking("");
                    
                    // Aqu칤 usamos el originalBuffer que NO ha sido tocado por PDF.js
                    const originalPdf = await PDFLib.PDFDocument.load(originalBuffer);
                    const zip = new JSZip();
                    const folder = zip.folder("Comprobantes_Separados");

                    for (let idx = 0; idx < validGroups.length; idx++) {
                        const group = validGroups[idx];
                        setLog(`Generando archivo: ${group.number}.pdf`);
                        setProgress(50 + Math.round(((idx + 1) / validGroups.length) * 50));
                        
                        const newPdf = await PDFLib.PDFDocument.create();
                        const copiedPages = await newPdf.copyPages(originalPdf, group.pages);
                        copiedPages.forEach(p => newPdf.addPage(p));

                        const pdfBytes = await newPdf.save();
                        
                        // Limpieza de nombre de archivo
                        const cleanNum = group.number.replace(/[^a-zA-Z0-9-]/g, '');
                        const filename = `${cleanNum || 'Sin_Numero'}.pdf`;
                        folder.file(filename, pdfBytes);
                    }

                    // --- FASE 3: COMPRESI칍N ---
                    setLog("Creando ZIP...");
                    const content = await zip.generateAsync({ type: "blob" });
                    setZipBlob(content);
                    setStatus('ready');
                    setProgress(100);

                } catch (error) {
                    console.error(error);
                    setStatus('error');
                    setLog("Error: " + error.message);
                }
            };

            const downloadZip = () => {
                if (!zipBlob) return;
                const url = window.URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Contabilidad_IA_${new Date().toISOString().slice(0,10)}.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            };

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4 font-sans">
                    
                    {/* Header */}
                    <div className="text-center mb-8 space-y-2">
                        <div className="inline-flex p-3 bg-indigo-600 rounded-2xl shadow-lg shadow-indigo-200 mb-2 relative overflow-hidden group">
                            <div className="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform"></div>
                            <span className="text-white relative"><Icons.Sparkles /></span>
                        </div>
                        <h1 className="text-3xl font-bold text-slate-800 tracking-tight">Separador Contable AI</h1>
                        <p className="text-slate-500 max-w-md mx-auto">
                            Potenciado por Gemini 2.0 Flash para un an치lisis l칩gico de documentos.
                        </p>
                    </div>

                    {/* Card Principal */}
                    <div className="glass-panel bg-white w-full max-w-3xl rounded-3xl shadow-xl overflow-hidden transition-all duration-300">
                        
                        {/* Configuraci칩n IA */}
                        {status === 'idle' && (
                            <div className="bg-indigo-50 px-6 py-4 border-b border-indigo-100 flex flex-col sm:flex-row items-center justify-between gap-4">
                                <div className="flex items-center gap-3">
                                    <div className="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="toggle" id="toggle" className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300" 
                                            checked={useAI} onChange={() => setUseAI(!useAI)}/>
                                        <label htmlFor="toggle" className={`toggle-label block overflow-hidden h-6 rounded-full cursor-pointer transition-colors duration-300 ${useAI ? 'bg-indigo-600' : 'bg-slate-300'}`}></label>
                                    </div>
                                    <label htmlFor="toggle" className="text-sm font-medium text-slate-700 cursor-pointer">
                                        {useAI ? 'Modo Inteligencia Artificial (Lento pero Preciso)' : 'Modo Reglas Cl치sicas (R치pido)'}
                                    </label>
                                </div>
                                {useAI && (
                                    <input 
                                        type="password" 
                                        value={apiKey} 
                                        onChange={(e) => setApiKey(e.target.value)}
                                        placeholder="API Key (Opcional)"
                                        className="text-xs border border-indigo-200 rounded px-2 py-1 bg-white/50 w-32 focus:w-64 transition-all outline-none focus:border-indigo-400"
                                    />
                                )}
                            </div>
                        )}

                        {/* Zona de Carga */}
                        {status === 'idle' && (
                            <div className="p-10 text-center border-b border-slate-100">
                                <label className="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-slate-300 rounded-2xl cursor-pointer hover:bg-slate-50 hover:border-indigo-400 transition-all group">
                                    <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                        <div className="text-slate-400 group-hover:text-indigo-500 mb-3 transition-colors transform group-hover:scale-110 duration-300">
                                            <Icons.Upload />
                                        </div>
                                        <p className="mb-2 text-lg text-slate-600 font-medium">Cargar PDF Contable</p>
                                        <p className="text-xs text-slate-400">Soporta archivos grandes de Ofima, SAP, Siigo.</p>
                                    </div>
                                    <input type="file" className="hidden" accept=".pdf" onChange={handleFile} />
                                </label>
                            </div>
                        )}

                        {/* Vista de Archivo Cargado */}
                        {file && status === 'idle' && (
                            <div className="p-6 bg-slate-50 border-b border-slate-100 flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="bg-red-100 p-2 rounded-lg text-red-600">
                                        <Icons.FileCheck />
                                    </div>
                                    <div>
                                        <p className="font-semibold text-slate-700">{file.name}</p>
                                        <p className="text-xs text-slate-500">{(file.size / 1024 / 1024).toFixed(2)} MB</p>
                                    </div>
                                </div>
                                <button 
                                    onClick={analyzeAndProcess}
                                    className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl font-medium shadow-md shadow-indigo-200 transition-all active:scale-95 flex items-center gap-2"
                                >
                                    {useAI ? <Icons.Sparkles /> : <Icons.Layers />} 
                                    {useAI ? 'Analizar con IA' : 'Dividir R치pido'}
                                </button>
                            </div>
                        )}

                        {/* Estado de Progreso & Pensamiento IA */}
                        {(status === 'analyzing' || status === 'processing') && (
                            <div className="p-10 text-center">
                                <div className="mb-2 flex justify-between text-sm font-bold text-slate-700">
                                    <span>{log}</span>
                                    <span className="text-indigo-600">{progress}%</span>
                                </div>
                                
                                {/* Barra de progreso */}
                                <div className="w-full bg-slate-200 rounded-full h-2.5 mb-6 overflow-hidden relative">
                                    <div className="absolute inset-0 bg-white/30 w-full h-full animate-[shimmer_2s_infinite] bg-gradient-to-r from-transparent via-white/30 to-transparent translate-x-[-100%]"></div>
                                    <div 
                                        className="bg-indigo-600 h-2.5 rounded-full transition-all duration-500 ease-out relative" 
                                        style={{ width: `${progress}%` }}
                                    ></div>
                                </div>

                                {/* Pensamiento IA en tiempo real */}
                                {useAI && (
                                    <div className="bg-slate-900 text-green-400 font-mono text-xs p-4 rounded-lg text-left h-24 overflow-y-auto shadow-inner border border-slate-700">
                                        <span className="opacity-50 select-none mr-2">$ gemini-analysis:</span>
                                        <span className="typing-effect">{currentThinking}</span>
                                        <span className="animate-pulse">_</span>
                                    </div>
                                )}
                                
                                {!useAI && (
                                    <div className="inline-block animate-spin-slow text-indigo-500 mt-4">
                                        <Icons.Refresh />
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Resultados */}
                        {status === 'ready' && (
                            <div className="flex flex-col h-[500px]">
                                <div className="p-6 bg-green-50 border-b border-green-100">
                                    <div className="flex items-center gap-3 mb-2">
                                        <div className="bg-green-100 text-green-700 p-2 rounded-full"><Icons.FileCheck /></div>
                                        <h2 className="text-xl font-bold text-slate-800">Proceso Terminado</h2>
                                    </div>
                                    <p className="text-slate-600 text-sm">
                                        Se han generado <strong>{groupedDocs.length} documentos</strong> PDF independientes.
                                    </p>
                                </div>

                                {/* Lista de Resultados */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/50">
                                    {groupedDocs.map((doc, idx) => (
                                        <div key={idx} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center hover:shadow-md transition-shadow gap-3">
                                            <div className="flex items-start gap-3">
                                                <div className="bg-indigo-50 text-indigo-600 font-bold text-xs w-8 h-8 flex items-center justify-center rounded-lg mt-1 shrink-0">
                                                    {idx + 1}
                                                </div>
                                                <div>
                                                    <h3 className="font-semibold text-slate-800 text-sm">{doc.number}.pdf</h3>
                                                    <div className="flex flex-wrap gap-2 mt-1">
                                                        <span className="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded-md">
                                                            {doc.pages.length} p치gs
                                                        </span>
                                                        {useAI && doc.reasoning && (
                                                            <span className="text-[10px] bg-yellow-50 text-yellow-700 px-2 py-0.5 rounded-md border border-yellow-100 max-w-[200px] truncate block sm:inline" title={doc.reasoning}>
                                                                游뱄 {doc.reasoning}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="text-right w-full sm:w-auto pl-11 sm:pl-0">
                                                <span className={`text-xs font-medium px-2 py-1 rounded-full ${
                                                    doc.confidence.includes('IA') ? 'bg-indigo-100 text-indigo-700' : 'bg-green-100 text-green-700'
                                                }`}>
                                                    {doc.confidence}
                                                </span>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                {/* Footer de Descarga */}
                                <div className="p-6 bg-white border-t border-slate-100 flex justify-between items-center">
                                    <button onClick={resetState} className="text-slate-500 hover:text-slate-800 text-sm font-medium px-4">
                                        Reiniciar
                                    </button>
                                    <button 
                                        onClick={downloadZip}
                                        className="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-green-200 transition-transform active:scale-95 flex items-center gap-2"
                                    >
                                        <Icons.Download /> Descargar ZIP
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Error */}
                        {status === 'error' && (
                            <div className="p-8 text-center">
                                <div className="bg-red-50 inline-flex p-4 rounded-full text-red-500 mb-4">
                                    <Icons.Alert />
                                </div>
                                <h3 className="text-lg font-bold text-slate-800 mb-2">Error en el proceso</h3>
                                <p className="text-slate-500 mb-6 font-mono text-xs bg-slate-100 p-2 rounded">{log}</p>
                                <button onClick={resetState} className="bg-slate-800 text-white px-6 py-2 rounded-lg hover:bg-slate-700">
                                    Intentar de nuevo
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
